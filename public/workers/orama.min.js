/**
 * Bundled by jsDelivr using Rollup v2.79.2 and Terser v5.39.0.
 * Original file: /npm/@orama/orama@2.0.15/dist/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
const e={arabic:"ar",armenian:"am",bulgarian:"bg",danish:"dk",dutch:"nl",english:"en",finnish:"fi",french:"fr",german:"de",greek:"gr",hungarian:"hu",indian:"in",indonesian:"id",irish:"ie",italian:"it",lithuanian:"lt",nepali:"np",norwegian:"no",portuguese:"pt",romanian:"ro",russian:"ru",serbian:"rs",slovenian:"ru",spanish:"es",swedish:"se",tamil:"ta",turkish:"tr",ukrainian:"uk",sanskrit:"sk"},t={dutch:/[^A-Za-zàèéìòóù0-9_'-]+/gim,english:/[^A-Za-zàèéìòóù0-9_'-]+/gim,french:/[^a-z0-9äâàéèëêïîöôùüûœç-]+/gim,italian:/[^A-Za-zàèéìòóù0-9_'-]+/gim,norwegian:/[^a-z0-9_æøåÆØÅäÄöÖüÜ]+/gim,portuguese:/[^a-z0-9à-úÀ-Ú]/gim,russian:/[^a-z0-9а-яА-ЯёЁ]+/gim,spanish:/[^a-z0-9A-Zá-úÁ-ÚñÑüÜ]+/gim,swedish:/[^a-z0-9_åÅäÄöÖüÜ-]+/gim,german:/[^a-z0-9A-ZäöüÄÖÜß]+/gim,finnish:/[^a-z0-9äöÄÖ]+/gim,danish:/[^a-z0-9æøåÆØÅ]+/gim,hungarian:/[^a-z0-9áéíóöőúüűÁÉÍÓÖŐÚÜŰ]+/gim,romanian:/[^a-z0-9ăâîșțĂÂÎȘȚ]+/gim,serbian:/[^a-z0-9čćžšđČĆŽŠĐ]+/gim,turkish:/[^a-z0-9çÇğĞıİöÖşŞüÜ]+/gim,lithuanian:/[^a-z0-9ąčęėįšųūžĄČĘĖĮŠŲŪŽ]+/gim,arabic:/[^a-z0-9أ-ي]+/gim,nepali:/[^a-z0-9अ-ह]+/gim,irish:/[^a-z0-9áéíóúÁÉÍÓÚ]+/gim,indian:/[^a-z0-9अ-ह]+/gim,armenian:/[^a-z0-9ա-ֆ]+/gim,greek:/[^a-z0-9α-ωά-ώ]+/gim,indonesian:/[^a-z0-9]+/gim,ukrainian:/[^a-z0-9а-яА-ЯіїєІЇЄ]+/gim,slovenian:/[^a-z0-9čžšČŽŠ]+/gim,bulgarian:/[^a-z0-9а-яА-Я]+/gim,tamil:/[^a-z0-9அ-ஹ]+/gim,sanskrit:/[^a-z0-9A-Zāīūṛḷṃṁḥśṣṭḍṇṅñḻḹṝ]+/gim},n=Object.keys(e);var o="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};function r(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}var a=r,i=s;function c(e){if(a===setTimeout)return setTimeout(e,0);if((a===r||!a)&&setTimeout)return a=setTimeout,setTimeout(e,0);try{return a(e,0)}catch(t){try{return a.call(null,e,0)}catch(t){return a.call(this,e,0)}}}"function"==typeof o.setTimeout&&(a=setTimeout),"function"==typeof o.clearTimeout&&(i=clearTimeout);var l,u=[],f=!1,d=-1;function h(){f&&l&&(f=!1,l.length?u=l.concat(u):d=-1,u.length&&p())}function p(){if(!f){var e=c(h);f=!0;for(var t=u.length;t;){for(l=u,u=[];++d<t;)l&&l[d].run();d=-1,t=u.length}l=null,f=!1,function(e){if(i===clearTimeout)return clearTimeout(e);if((i===s||!i)&&clearTimeout)return i=clearTimeout,clearTimeout(e);try{return i(e)}catch(t){try{return i.call(null,e)}catch(t){return i.call(this,e)}}}(e)}}function m(e,t){this.fun=e,this.array=t}m.prototype.run=function(){this.fun.apply(null,this.array)};function g(){}var y=g,b=g,w=g,v=g,I=g,S=g,T=g;var D=o.performance||{},_=D.now||D.mozNow||D.msNow||D.oNow||D.webkitNow||function(){return(new Date).getTime()};var O=new Date;var A={nextTick:function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];u.push(new m(e,t)),1!==u.length||f||c(p)},title:"browser",browser:!0,env:{},argv:[],version:"",versions:{},on:y,addListener:b,once:w,off:v,removeListener:I,removeAllListeners:S,emit:T,binding:function(e){throw new Error("process.binding is not supported")},cwd:function(){return"/"},chdir:function(e){throw new Error("process.chdir is not supported")},umask:function(){return 0},hrtime:function(e){var t=.001*_.call(D),n=Math.floor(t),o=Math.floor(t%1*1e9);return e&&(n-=e[0],(o-=e[1])<0&&(n--,o+=1e9)),[n,o]},platform:"browser",release:{},config:{},uptime:function(){return(new Date-O)/1e3}};const k=Date.now().toString().slice(5);let x=0;const E=BigInt(1e3),P=BigInt(1e6),N=BigInt(1e9),M=65535;function R(e,t){if(t.length<M)Array.prototype.push.apply(e,t);else{const n=t.length;for(let o=0;o<n;o+=M)Array.prototype.push.apply(e,t.slice(o,o+M))}}function z(){return BigInt(Math.floor(1e6*performance.now()))}async function U(e){return"number"==typeof e&&(e=BigInt(e)),e<E?`${e}ns`:e<P?e/E+"μs":e<N?e/P+"ms":e/N+"s"}async function C(){var e;return"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?z():void 0!==A&&A.release&&"node"===A.release.name||void 0!==A&&"function"==typeof(null==A||null===(e=A.hrtime)||void 0===e?void 0:e.bigint)?A.hrtime.bigint():"undefined"!=typeof performance?z():BigInt(0)}async function L(){return`${k}-${x++}`}function j(e,t){return void 0===Object.hasOwn?Object.prototype.hasOwnProperty.call(e,t)?e[t]:void 0:Object.hasOwn(e,t)?e[t]:void 0}function B(e,t){return t[1]===e[1]?e[0]-t[0]:t[1]-e[1]}function W(e){if(0===e.length)return[];if(1===e.length)return e[0];for(let t=1;t<e.length;t++)if(e[t].length<e[0].length){const n=e[0];e[0]=e[t],e[t]=n}const t=new Map;for(const n of e[0])t.set(n,1);for(let n=1;n<e.length;n++){let o=0;for(const r of e[n]){const e=t.get(r);e===n&&(t.set(r,e+1),o++)}if(0===o)return[]}return e[0].filter((n=>{const o=t.get(n);return void 0!==o&&t.set(n,0),o===e.length}))}async function V(e,t){const n={},o=t.length;for(let r=0;r<o;r++){const o=t[r],s=o.split(".");let a=e;const i=s.length;for(let e=0;e<i;e++)if(a=a[s[e]],"object"==typeof a){if(null!==a&&"lat"in a&&"lon"in a&&"number"==typeof a.lat&&"number"==typeof a.lon){a=n[o]=a;break}if(!Array.isArray(a)&&null!==a&&e===i-1){a=void 0;break}}else if((null===a||"object"!=typeof a)&&e<i-1){a=void 0;break}void 0!==a&&(n[o]=a)}return n}async function F(e,t){return(await V(e,[t]))[t]}const $={cm:.01,m:1,km:1e3,ft:.3048,yd:.9144,mi:1609.344};function G(e,t){const n=$[t];if(void 0===n)throw new Error(H("INVALID_DISTANCE_SUFFIX",e).message);return e*n}function Y(e,t){e.hits=e.hits.map((e=>({...e,document:{...e.document,...t.reduce(((e,t)=>{const n=t.split("."),o=n.pop();let r=e;for(const e of n)r[e]=r[e]??{},r=r[e];return r[o]=null,e}),e.document)}})))}const q={NO_LANGUAGE_WITH_CUSTOM_TOKENIZER:"Do not pass the language option to create when using a custom tokenizer.",LANGUAGE_NOT_SUPPORTED:`Language "%s" is not supported.\nSupported languages are:\n - ${n.join("\n - ")}`,INVALID_STEMMER_FUNCTION_TYPE:"config.stemmer property must be a function.",MISSING_STEMMER:'As of version 1.0.0 @orama/orama does not ship non English stemmers by default. To solve this, please explicitly import and specify the "%s" stemmer from the package @orama/stemmers. See https://docs.oramasearch.com/open-source/text-analysis/stemming for more information.',CUSTOM_STOP_WORDS_MUST_BE_FUNCTION_OR_ARRAY:"Custom stop words array must only contain strings.",UNSUPPORTED_COMPONENT:'Unsupported component "%s".',COMPONENT_MUST_BE_FUNCTION:'The component "%s" must be a function.',COMPONENT_MUST_BE_FUNCTION_OR_ARRAY_FUNCTIONS:'The component "%s" must be a function or an array of functions.',INVALID_SCHEMA_TYPE:'Unsupported schema type "%s" at "%s". Expected "string", "boolean" or "number" or array of them.',DOCUMENT_ID_MUST_BE_STRING:'Document id must be of type "string". Got "%s" instead.',DOCUMENT_ALREADY_EXISTS:'A document with id "%s" already exists.',DOCUMENT_DOES_NOT_EXIST:'A document with id "%s" does not exists.',MISSING_DOCUMENT_PROPERTY:'Missing searchable property "%s".',INVALID_DOCUMENT_PROPERTY:'Invalid document property "%s": expected "%s", got "%s"',UNKNOWN_INDEX:'Invalid property name "%s". Expected a wildcard string ("*") or array containing one of the following properties: %s',INVALID_BOOST_VALUE:"Boost value must be a number greater than, or less than 0.",INVALID_FILTER_OPERATION:"You can only use one operation per filter, you requested %d.",SCHEMA_VALIDATION_FAILURE:'Cannot insert document due schema validation failure on "%s" property.',INVALID_SORT_SCHEMA_TYPE:'Unsupported sort schema type "%s" at "%s". Expected "string" or "number".',CANNOT_SORT_BY_ARRAY:'Cannot configure sort for "%s" because it is an array (%s).',UNABLE_TO_SORT_ON_UNKNOWN_FIELD:'Unable to sort on unknown field "%s". Allowed fields: %s',SORT_DISABLED:"Sort is disabled. Please read the documentation at https://docs.oramasearch for more information.",UNKNOWN_GROUP_BY_PROPERTY:'Unknown groupBy property "%s".',INVALID_GROUP_BY_PROPERTY:'Invalid groupBy property "%s". Allowed types: "%s", but given "%s".',UNKNOWN_FILTER_PROPERTY:'Unknown filter property "%s".',INVALID_VECTOR_SIZE:'Vector size must be a number greater than 0. Got "%s" instead.',INVALID_VECTOR_VALUE:'Vector value must be a number greater than 0. Got "%s" instead.',INVALID_INPUT_VECTOR:'Property "%s" was declared as a %s-dimensional vector, but got a %s-dimensional vector instead.\nInput vectors must be of the size declared in the schema, as calculating similarity between vectors of different sizes can lead to unexpected results.',WRONG_SEARCH_PROPERTY_TYPE:'Property "%s" is not searchable. Only "string" properties are searchable.',FACET_NOT_SUPPORTED:'Facet doens\'t support the type "%s".',INVALID_DISTANCE_SUFFIX:'Invalid distance suffix "%s". Valid suffixes are: cm, m, km, mi, yd, ft.',INVALID_SEARCH_MODE:'Invalid search mode "%s". Valid modes are: "fulltext", "vector", "hybrid".',MISSING_VECTOR_AND_SECURE_PROXY:"No vector was provided and no secure proxy was configured. Please provide a vector or configure an Orama Secure Proxy to perform hybrid search.",MISSING_TERM:'"term" is a required parameter when performing hybrid search. Please provide a search term.',INVALID_VECTOR_INPUT:'Invalid "vector" property. Expected an object with "value" and "property" properties, but got "%s" instead.',PLUGIN_CRASHED:"A plugin crashed during initialization. Please check the error message for more information:"};function H(e,...t){const n=new Error(function(e,...t){return e.replace(/%(?:(?<position>\d+)\$)?(?<width>-?\d*\.?\d*)(?<type>[dfs])/g,(function(...e){const n=e[e.length-1],{width:o,type:r,position:s}=n,a=s?t[Number.parseInt(s)-1]:t.shift(),i=""===o?0:Number.parseInt(o);switch(r){case"d":return a.toString().padStart(i,"0");case"f":{let e=a;const[t,n]=o.split(".").map((e=>Number.parseFloat(e)));return"number"==typeof n&&n>=0&&(e=e.toFixed(n)),"number"==typeof t&&t>=0?e.toString().padStart(i,"0"):e.toString()}case"s":return i<0?a.toString().padEnd(-i," "):a.toString().padStart(i," ");default:return a}}))}(q[e]??`Unsupported Orama Error code: ${e}`,...t));return n.code=e,"captureStackTrace"in Error.prototype&&Error.captureStackTrace(n),n}async function K(e){return{raw:Number(e),formatted:await U(e)}}async function X(e){if(e.id){if("string"!=typeof e.id)throw H("DOCUMENT_ID_MUST_BE_STRING",typeof e.id);return e.id}return await L()}async function Z(e,t){for(const[n,o]of Object.entries(t)){const t=e[n];if(void 0!==t&&(("geopoint"!==o||"object"!=typeof t||"number"!=typeof t.lon||"number"!=typeof t.lat)&&("enum"!==o||"string"!=typeof t&&"number"!=typeof t)))if("enum[]"===o&&Array.isArray(t)){const e=t.length;for(let o=0;o<e;o++)if("string"!=typeof t[o]&&"number"!=typeof t[o])return n+"."+o}else if(te(o)){const e=re(o);if(!Array.isArray(t)||t.length!==e)throw H("INVALID_INPUT_VECTOR",n,e,t.length)}else if(ne(o)){if(!Array.isArray(t))return n;const e=oe(o),r=t.length;for(let o=0;o<r;o++)if(typeof t[o]!==e)return n+"."+o}else if("object"!=typeof o){if(typeof t!==o)return n}else{if(!t||"object"!=typeof t)return n;const e=await Z(t,o);if(e)return n+"."+e}}}const J={string:!1,number:!1,boolean:!1,enum:!1,geopoint:!1,"string[]":!0,"number[]":!0,"boolean[]":!0,"enum[]":!0},Q={"string[]":"string","number[]":"number","boolean[]":"boolean","enum[]":"enum"};function ee(e){return"geopoint"===e}function te(e){return"string"==typeof e&&/^vector\[\d+\]$/.test(e)}function ne(e){return"string"==typeof e&&J[e]}function oe(e){return Q[e]}function re(e){const t=Number(e.slice(7,-1));switch(!0){case isNaN(t):throw H("INVALID_VECTOR_VALUE",e);case t<=0:throw H("INVALID_VECTOR_SIZE",e);default:return t}}function se(){return{idToInternalId:new Map,internalIdToId:[],save:ae,load:ie}}function ae(e){return{internalIdToId:e.internalIdToId}}function ie(e,t){const{internalIdToId:n}=t;e.internalDocumentIDStore.idToInternalId.clear(),e.internalDocumentIDStore.internalIdToId=[];const o=n.length;for(let t=0;t<o;t++){const o=n[t];e.internalDocumentIDStore.idToInternalId.set(o,t+1),e.internalDocumentIDStore.internalIdToId.push(o)}}function ce(e,t){if("string"==typeof t){const n=e.idToInternalId.get(t);if(n)return n;const o=e.idToInternalId.size+1;return e.idToInternalId.set(t,o),e.internalIdToId.push(t),o}return t>e.internalIdToId.length?ce(e,t.toString()):t}function le(e,t){if(e.internalIdToId.length<t)throw new Error(`Invalid internalId ${t}`);return e.internalIdToId[t-1]}var ue=Object.freeze({__proto__:null,createInternalDocumentIDStore:se,save:ae,load:ie,getInternalDocumentId:ce,getDocumentIdFromInternalId:le});async function fe(e,t){return{sharedInternalDocumentStore:t,docs:{},count:0}}async function de(e,t){const n=ce(e.sharedInternalDocumentStore,t);return e.docs[n]}async function he(e,t){const n=t.length,o=Array.from({length:n});for(let r=0;r<n;r++){const n=ce(e.sharedInternalDocumentStore,t[r]);o[r]=e.docs[n]}return o}async function pe(e){return e.docs}async function me(e,t,n){const o=ce(e.sharedInternalDocumentStore,t);return void 0===e.docs[o]&&(e.docs[o]=n,e.count++,!0)}async function ge(e,t){const n=ce(e.sharedInternalDocumentStore,t);return void 0!==e.docs[n]&&(delete e.docs[n],e.count--,!0)}async function ye(e){return e.count}async function be(e,t){const n=t;return{docs:n.docs,count:n.count,sharedInternalDocumentStore:e}}async function we(e){return{docs:e.docs,count:e.count}}async function ve(){return{create:fe,get:de,getMultiple:he,getAll:pe,store:me,remove:ge,count:ye,load:be,save:we}}var Ie=Object.freeze({__proto__:null,create:fe,get:de,getMultiple:he,getAll:pe,store:me,remove:ge,count:ye,load:be,save:we,createDocumentsStore:ve});const Se=["beforeInsert","afterInsert","beforeRemove","afterRemove","beforeUpdate","afterUpdate","beforeSearch","afterSearch","beforeInsertMultiple","afterInsertMultiple","beforeRemoveMultiple","afterRemoveMultiple","beforeUpdateMultiple","afterUpdateMultiple","beforeLoad","afterLoad","afterCreate"];async function Te(e,t){var n;const o=[],r=null===(n=e.plugins)||void 0===n?void 0:n.length;if(!r)return o;for(let n=0;n<r;n++)try{const r=await e.plugins[n];"function"==typeof r[t]&&o.push(r[t])}catch(e){throw console.error("Caught error in getAllPluginsByHook:",e),H("PLUGIN_CRASHED")}return o}const De=["tokenizer","index","documentsStore","sorter"],_e=["validateSchema","getDocumentIndexId","getDocumentProperties","formatElapsedTime"];async function Oe(e,t,n,o){const r=e.length;for(let s=0;s<r;s++)await e[s](t,n,o)}async function Ae(e,t,n){const o=e.length;for(let r=0;r<o;r++)await e[r](t,n)}async function ke(e,t,n,o,r){const s=e.length;for(let a=0;a<s;a++)await e[a](t,n,o,r)}async function xe(e,t,n,o){const r=e.length;for(let s=0;s<r;s++)await e[s](t,n,o)}function Ee(e){const t=e.r;return e.r=t.l,t.l=e,e.h=Math.max(Ue(e.l),Ue(e.r))+1,t.h=Math.max(Ue(t.l),Ue(t.r))+1,t}function Pe(e){const t=e.l;return e.l=t.r,t.r=e,e.h=Math.max(Ue(e.l),Ue(e.r))+1,t.h=Math.max(Ue(t.l),Ue(t.r))+1,t}function Ne(e,t,n){const o=[];return function e(r){null!==r&&(t<r.k&&e(r.l),r.k>=t&&r.k<=n&&R(o,r.v),n>r.k&&e(r.r))}(e.root),o}function Me(e,t,n=!1){const o=[];return function e(r){null!==r&&(n&&r.k>=t&&R(o,r.v),!n&&r.k>t&&R(o,r.v),e(r.l),e(r.r))}(e.root),o}function Re(e,t,n=!1){const o=[];return function e(r){null!==r&&(n&&r.k<=t&&R(o,r.v),!n&&r.k<t&&R(o,r.v),e(r.l),e(r.r))}(e.root),o}function ze(e,t){for(;null!==e;)if(t<e.k)e=e.l;else{if(!(t>e.k))return e;e=e.r}return null}function Ue(e){return null!==e?e.h:-1}function Ce(e,t){const n=ze(e.root,t);return null===n?null:n.v}function Le(e,t){const n=Object.keys(t);if(1!==n.length)throw new Error("Invalid operation");const o=n[0];switch(o){case"eq":{const n=t[o];return e.numberToDocumentId.get(n)??[]}case"in":{const n=t[o],r=[];for(const t of n){const n=e.numberToDocumentId.get(t);null!=n&&R(r,n)}return r}case"nin":{const n=t[o],r=[],s=e.numberToDocumentId.keys();for(const t of s){if(n.includes(t))continue;const o=e.numberToDocumentId.get(t);null!=o&&R(r,o)}return r}}throw new Error("Invalid operation")}function je(e,t){const n=Object.keys(t);if(1!==n.length)throw new Error("Invalid operation");const o=n[0];if("containsAll"===o){return W(t[o].map((t=>e.numberToDocumentId.get(t)??[])))}throw new Error("Invalid operation")}function Be(e,t,n){if(e===t)return 0;const o=e;e.length>t.length&&(e=t,t=o);let r=e.length,s=t.length,a=0;for(;a<r&&e.charCodeAt(a)===t.charCodeAt(a);)a++;if(a===r)return 0;for(;r>0&&e.charCodeAt(~-r)===t.charCodeAt(~-s);)r--,s--;if(!r)return s>n?-1:s;if(r-=a,s-=a,r<=n&&s<=n)return r>s?r:s;const i=s-r;if(n>s)n=s;else if(i>n)return-1;let c=0;const l=[],u=[];for(;c<n;)u[c]=t.charCodeAt(a+c),l[c]=++c;for(;c<s;)u[c]=t.charCodeAt(a+c),l[c++]=n+1;const f=n-i,d=n<s;let h=0,p=n,m=0,g=0,y=0,b=0,w=0;for(c=0;c<r;c++){for(g=c,m=c+1,b=e.charCodeAt(a+c),h+=c>f?1:0,p+=p<s?1:0,w=h;w<p;w++)y=m,m=g,g=l[w],b!==u[w]&&(g<m&&(m=g),y<m&&(m=y),m++),l[w]=m;if(d&&l[c+i]>n)return-1}return m<=n?m:-1}function We(e,t,n){const o=Be(e,t,n);return{distance:o,isBounded:o>=0}}class Ve{constructor(e,t,n){this.k=e,this.s=t,this.e=n}c={};d=[];w="";toJSON(){return{w:this.w,s:this.s,c:this.c,d:this.d,e:this.e}}}function Fe(e,t){e.w=t.w+e.s}function $e(e,t){e.d.push(t)}function Ge(e,t){const n=e.d.indexOf(t);return-1!==n&&(e.d.splice(n,1),!0)}function Ye(e,t,n,o,r){if(e.e){const{w:s,d:a}=e;if(o&&s!==n)return{};if(null==j(t,s))if(r){Math.abs(n.length-s.length)<=r&&We(n,s,r).isBounded&&(t[s]=[])}else t[s]=[];if(null!=j(t,s)&&a.length>0){const e=new Set(t[s]),n=a.length;for(let t=0;t<n;t++)e.add(a[t]);t[s]=Array.from(e)}}for(const s of Object.keys(e.c))Ye(e.c[s],t,n,o,r);return t}function qe(e,t){let n="";const o=Math.min(e.length,t.length);for(let r=0;r<o;r++){if(e[r]!==t[r])return n;n+=e[r]}return n}function He(e=!1,t="",n=""){return new Ve(n,t,e)}function Ke(e,t,n){const o=t.length;for(let r=0;r<o;r++){const o=t[r],s=t.substring(r),a=e.c[o];if(!a){const t=He(!0,s,o);return $e(t,n),e.c[o]=t,void Fe(t,e)}{const i=a.s,c=i.length,l=qe(i,s),u=l.length;if(i===s)return $e(a,n),void(a.e=!0);const f=i[u];if(u<c&&u===s.length){const t=He(!0,s,o);t.c[f]=a;const r=t.c[f];return r.s=i.substring(u),r.k=f,e.c[o]=t,Fe(t,e),Fe(r,t),void $e(t,n)}if(u<c&&u<s.length){const c=He(!1,l,o);c.c[f]=a,e.c[o]=c;const d=c.c[f];d.s=i.substring(u),d.k=f;const h=s[u],p=He(!0,t.substring(r+u),h);return $e(p,n),c.c[h]=p,Fe(c,e),Fe(p,c),void Fe(d,c)}r+=c-1,e=a}}}function Xe(e,t,n,o,r,s){if(!(o<0))if(e.w.startsWith(t))Ye(e,s,t,!1,0);else{if(e.e){const{w:n,d:o}=e;if(n&&(We(t,n,r).isBounded&&(s[n]=[]),null!=j(s,n)&&o.length>0)){const e=new Set(s[n]),t=o.length;for(let n=0;n<t;n++)e.add(o[n]);s[n]=Array.from(e)}}if(!(n>=t.length)){t[n]in e.c&&Xe(e.c[t[n]],t,n+1,o,r,s),Xe(e,t,n+1,o-1,r,s);for(const a in e.c)Xe(e.c[a],t,n,o-1,r,s);for(const a in e.c)a!==t[n]&&Xe(e.c[a],t,n+1,o-1,r,s)}}}function Ze(e,{term:t,exact:n,tolerance:o}){if(o&&!n){const n={};return Xe(e,t,0,(o=o||0)||0,o,n),n}{const r=t.length;for(let n=0;n<r;n++){const r=t[n];if(!(r in e.c))return{};{const s=e.c[r],a=s.s,i=t.substring(n),c=qe(a,i).length;if(c!==a.length&&c!==i.length){if(o)break;return{}}n+=s.s.length-1,e=s}}const s={};return Ye(e,s,t,n,o),s}}function Je(e,t,n,o=!0){if(!t)return!0;const r=t.length;for(let s=0;s<r;s++){const r=t[s];if(!(r in e.c))return!1;{const a=e.c[r];s+=a.s.length-1,e=a,o&&e.w!==t||Ge(e,n)}}return!0}function Qe(e,t,n,o=!0,r="asc",s=!1){const a=s?ot:nt,i=[{node:e,depth:0}],c=[];for(;i.length>0;){const{node:e,depth:r}=i.pop();if(null===e)continue;const s=a(t,e.point);(o?s<=n:s>n)&&c.push({point:e.point,docIDs:e.docIDs??[]}),null!=e.left&&i.push({node:e.left,depth:r+1}),null!=e.right&&i.push({node:e.right,depth:r+1})}return r&&c.sort(((e,n)=>{const o=a(t,e.point),s=a(t,n.point);return"asc"===r.toLowerCase()?o-s:s-o})),c}function et(e,t,n=!0,o=null,r=!1){const s=[{node:e,depth:0}],a=[];for(;s.length>0;){const e=s.pop();if(null==e||null==e.node)continue;const{node:o,depth:r}=e,i=r+1;null!=o.left&&s.push({node:o.left,depth:i}),null!=o.right&&s.push({node:o.right,depth:i});const c=tt(t,o.point);c&&n?a.push({point:o.point,docIDs:o.docIDs??[]}):c||n||a.push({point:o.point,docIDs:o.docIDs??[]})}const i=function(e){let t=0,n=0,o=0;const r=e.length;for(let s=0,a=r-1;s<r;a=s++){const r=e[s].lon,i=e[s].lat,c=e[a].lon,l=e[a].lat,u=r*l-c*i;t+=u,n+=(r+c)*u,o+=(i+l)*u}t/=2;const s=6*t;return n/=s,o/=s,{lon:n,lat:o}}(t);if(o){const e=r?ot:nt;a.sort(((t,n)=>{const r=e(i,t.point),s=e(i,n.point);return"asc"===o.toLowerCase()?r-s:s-r}))}return a}function tt(e,t){let n=!1;const o=t.lon,r=t.lat,s=e.length;for(let t=0,a=s-1;t<s;a=t++){const s=e[t].lon,i=e[t].lat,c=e[a].lon,l=e[a].lat;i>r!=l>r&&o<(c-s)*(r-i)/(l-i)+s&&(n=!n)}return n}function nt(e,t){const n=Math.PI/180,o=e.lat*n,r=t.lat*n,s=(t.lat-e.lat)*n,a=(t.lon-e.lon)*n,i=Math.sin(s/2)*Math.sin(s/2)+Math.cos(o)*Math.cos(r)*Math.sin(a/2)*Math.sin(a/2);return 6371e3*(2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)))}function ot(e,t){const n=6378137,o=1/298.257223563,r=(1-o)*n,s=Math.PI/180,a=e.lat*s,i=t.lat*s,c=(t.lon-e.lon)*s,l=Math.atan((1-o)*Math.tan(a)),u=Math.atan((1-o)*Math.tan(i)),f=Math.sin(l),d=Math.cos(l),h=Math.sin(u),p=Math.cos(u);let m,g,y,b,w,v,I=c,S=1e3;do{const e=Math.sin(I),t=Math.cos(I);b=Math.sqrt(p*e*(p*e)+(d*h-f*p*t)*(d*h-f*p*t)),w=f*h+d*p*t,v=Math.atan2(b,w),g=d*p*e/b,y=1-g*g;const n=w-2*f*h/y,r=o/16*y*(4+o*(4-3*y));m=I,I=c+(1-r)*o*g*(v+r*b*(n+r*w*(2*n*n-1)))}while(Math.abs(I-m)>1e-12&&--S>0);const T=y*(n*n-r*r)/(r*r),D=T/1024*(256+T*(T*(74-47*T)-128));return r*(1+T/16384*(4096+T*(T*(320-175*T)-768)))*(v-D*b*(w-2*f*h/y+D/4*(w*(2*b*b-1)-D/6*v*(4*b*b-3)*(4*v*v-3))))}function rt(e,t,n=1,o){if(0===t)throw H("INVALID_BOOST_VALUE");const r=new Map,s=e.length;for(let n=0;n<s;n++){const o=e[n],s=o.length;for(let e=0;e<s;e++){var a;const[n,s]=o[e],c=s*t,l=null===(a=r.get(n))||void 0===a?void 0:a[0];var i;if(void 0!==l)r.set(n,[1.5*l+c,((null===(i=null==r?void 0:r.get(n))||void 0===i?void 0:i[1])||0)+1]);else r.set(n,[c,1])}}const c=[];for(const e of r.entries())c.push([e[0],e[1][0]]);const l=c.sort(((e,t)=>t[1]-e[1]));if(1===n)return l;const u=l.length,f=[];for(const e of r.entries())f.push([e[0],e[1][0],e[1][1]]);const d=f.sort(((e,t)=>e[2]>t[2]?-1:e[2]<t[2]?1:e[1]>t[1]?-1:e[1]<t[1]?1:0));let h;for(let e=0;e<u&&d[e][2]===o;e++)h=e;if(void 0===h){if(0===n)return[];h=0}const p=d.length,m=new Array(p);for(let e=0;e<p;e++)m[e]=[d[e][0],d[e][1]];if(0===n)return m.slice(0,h+1);const g=h+Math.ceil(100*n*(u-h)/100);return m.slice(0,u+g)}function st(e,t,n,o,r,{k:s,b:a,d:i}){return Math.log(1+(n-t+.5)/(t+.5))*(i+e*(s+1))/(e+s*(1-a+a*o/r))}function at(e,t){let n=0;for(let o=0;o<t;o++)n+=e[o]*e[o];return Math.sqrt(n)}function it(e,t,n,o=.8){const r=at(e,n),s=[];for(const[a,[i,c]]of Object.entries(t)){let t=0;for(let o=0;o<n;o++)t+=e[o]*c[o];const l=t/(r*i);l>=o&&s.push([a,l])}return s.sort(((e,t)=>t[1]-e[1]))}async function ct(e,t,n,o,r){const s=ce(e.sharedInternalDocumentStore,n);e.avgFieldLength[t]=((e.avgFieldLength[t]??0)*(r-1)+o.length)/r,e.fieldLengths[t][s]=o.length,e.frequencies[t][s]={}}async function lt(e,t,n,o,r){let s=0;for(const e of o)e===r&&s++;const a=ce(e.sharedInternalDocumentStore,n),i=s/o.length;e.frequencies[t][a][r]=i,r in e.tokenOccurrences[t]||(e.tokenOccurrences[t][r]=0),e.tokenOccurrences[t][r]=(e.tokenOccurrences[t][r]??0)+1}async function ut(e,t,n,o){const r=ce(e.sharedInternalDocumentStore,n);e.avgFieldLength[t]=(e.avgFieldLength[t]*o-e.fieldLengths[t][r])/(o-1),e.fieldLengths[t][r]=void 0,e.frequencies[t][r]=void 0}async function ft(e,t,n){e.tokenOccurrences[t][n]--}async function dt(e,t,n,o,r){const s=Array.from(r),a=t.avgFieldLength[n],i=t.fieldLengths[n],c=t.tokenOccurrences[n],l=t.frequencies[n],u="number"==typeof c[o]?c[o]??0:0,f=[],d=s.length;for(let n=0;n<d;n++){var h;const r=ce(t.sharedInternalDocumentStore,s[n]),c=st((null==l||null===(h=l[r])||void 0===h?void 0:h[o])??0,u,e.docsCount,i[r],a,e.params.relevance);f.push([r,c])}return f}async function ht(e,t,n,o,r=""){o||(o={sharedInternalDocumentStore:t,indexes:{},vectorIndexes:{},searchableProperties:[],searchablePropertiesWithTypes:{},frequencies:{},tokenOccurrences:{},avgFieldLength:{},fieldLengths:{}});for(const[i,c]of Object.entries(n)){const n=`${r}${r?".":""}${i}`;if("object"!=typeof c||Array.isArray(c))if(te(c))o.searchableProperties.push(n),o.searchablePropertiesWithTypes[n]=c,o.vectorIndexes[n]={size:re(c),vectors:{}};else{const e=/\[/.test(c);switch(c){case"boolean":case"boolean[]":o.indexes[n]={type:"Bool",node:{true:[],false:[]},isArray:e};break;case"number":case"number[]":o.indexes[n]={type:"AVL",node:(s=0,a=[],{root:{k:s,v:a,l:null,r:null,h:0}}),isArray:e};break;case"string":case"string[]":o.indexes[n]={type:"Radix",node:He(),isArray:e},o.avgFieldLength[n]=0,o.frequencies[n]={},o.tokenOccurrences[n]={},o.fieldLengths[n]={};break;case"enum":case"enum[]":o.indexes[n]={type:"Flat",node:{numberToDocumentId:new Map},isArray:e};break;case"geopoint":o.indexes[n]={type:"BKD",node:{root:null},isArray:e};break;default:throw H("INVALID_SCHEMA_TYPE",Array.isArray(c)?"array":c,n)}o.searchableProperties.push(n),o.searchablePropertiesWithTypes[n]=c}else ht(e,t,c,o,n)}var s,a;return o}function pt(e,t,n,o,r,s,a){return async i=>{const c=ce(t.sharedInternalDocumentStore,o),{type:l,node:u}=t.indexes[n];switch(l){case"Bool":u[i?"true":"false"].push(c);break;case"AVL":d=i,h=[c],(f=u).root=function e(t,n,o){if(null===t)return{k:n,v:o,l:null,r:null,h:0};if(n<t.k)t.l=e(t.l,n,o);else{if(!(n>t.k)){for(const e of o)t.v.push(e);return t}t.r=e(t.r,n,o)}t.h=1+Math.max(Ue(t.l),Ue(t.r));const r=Ue(t.l)-Ue(t.r);return r>1&&n<t.l.k?Pe(t):r<-1&&n>t.r.k?Ee(t):r>1&&n>t.l.k?(t.l=Ee(t.l),Pe(t)):r<-1&&n<t.r.k?(t.r=Pe(t.r),Ee(t)):t}(f.root,d,h);break;case"Radix":{const o=await s.tokenize(i,r,n);await e.insertDocumentScoreParameters(t,n,c,o,a);for(const r of o)await e.insertTokenScoreParameters(t,n,c,o,r),Ke(u,r,c);break}case"Flat":!function(e,t,n){e.numberToDocumentId.has(t)?e.numberToDocumentId.get(t).push(n):e.numberToDocumentId.set(t,[n])}(u,i,c);break;case"BKD":!function(e,t,n){const o={point:t,docIDs:n};if(null==e.root)return void(e.root=o);let r=e.root,s=0;for(;null!==r;){if(r.point.lon===t.lon&&r.point.lat===t.lat){const e=r.docIDs??[];return void(r.docIDs=Array.from(new Set([...e,...n||[]])))}if(0==s%2)if(t.lon<r.point.lon){if(null==r.left)return void(r.left=o);r=r.left}else{if(null==r.right)return void(r.right=o);r=r.right}else if(t.lat<r.point.lat){if(null==r.left)return void(r.left=o);r=r.left}else{if(null==r.right)return void(r.right=o);r=r.right}s++}}(u,i,[c])}var f,d,h}}async function mt(e,t,n,o,r,s,a,i,c){if(te(s))return function(e,t,n,o){n instanceof Float32Array||(n=new Float32Array(n));const r=e.vectorIndexes[t].size,s=at(n,r);e.vectorIndexes[t].vectors[o]=[s,n]}(t,n,r,o);const l=pt(e,t,n,o,a,i,c);if(!ne(s))return l(r);const u=r,f=u.length;for(let e=0;e<f;e++)await l(u[e])}async function gt(e,t,n,o,r,s,a,i,c){const l=ce(t.sharedInternalDocumentStore,o);if(te(s))return delete t.vectorIndexes[n].vectors[o],!0;const{type:u,node:f}=t.indexes[n];switch(u){case"AVL":return function(e,t,n){const o=ze(e.root,n);o&&(1!==o.v.length?o.v.splice(o.v.indexOf(t),1):function(e,t){if(null===e||null===e.root)return;let n=e.root,o=null;for(;null!=n&&n.k!==t;)o=n,n=t<n.k?n.l:n.r;null!==n&&(()=>{if(null===n.l&&null===n.r)null===o?e.root=null:o.l===n?o.l=null:o.r=null;else if(null!=n.l&&null!=n.r){let e=n.r,t=n;for(;null!=e.l;)t=e,e=e.l;n.k=e.k,t===n?t.r=e.r:t.l=e.r}else{const t=null!=n.l?n.l:n.r;null===o?e.root=t:o.l===n?o.l=t:o.r=t}})()}(e,n))}(f,l,r),!0;case"Bool":{const e=f[r?"true":"false"].indexOf(l);return f[r?"true":"false"].splice(e,1),!0}case"Radix":{const s=await i.tokenize(r,a,n);await e.removeDocumentScoreParameters(t,n,o,c);for(const o of s)await e.removeTokenScoreParameters(t,n,o),Je(f,o,l);return!0}case"Flat":return function(e,t,n){var o,r;null==e||e.numberToDocumentId.set(n,(null===(o=null==e?void 0:e.numberToDocumentId.get(n))||void 0===o?void 0:o.filter((e=>e!==t)))??[]),0===(null===(r=null==e?void 0:e.numberToDocumentId.get(n))||void 0===r?void 0:r.length)&&(null==e||e.numberToDocumentId.delete(n))}(f,l,r),!0;case"BKD":return function(e,t,n){let o=e.root,r=0,s=null,a=null;for(;null!==o;){if((null==o?void 0:o.point.lon)===t.lon&&o.point.lat===t.lat){var i;const t=null===(i=o.docIDs)||void 0===i?void 0:i.indexOf(n);var c;if(void 0!==t&&t>-1)return null===(c=o.docIDs)||void 0===c||c.splice(t,1),void(null!=o.docIDs&&0!==o.docIDs.length||(null!=s?"left"===a?s.left=null!==o.left?o.left:o.right:"right"===a&&(s.right=null!==o.right?o.right:o.left):e.root=null!==o.left?o.left:o.right))}s=o,0==r%2?t.lon<o.point.lon?(o=null==o?void 0:o.left,a="left"):(o=null==o?void 0:o.right,a="right"):t.lat<o.point.lat?(o=null==o?void 0:o.left,a="left"):(o=null==o?void 0:o.right,a="right"),r++}}(f,r,l),!1}}async function yt(e,t,n,o,r,s,a,i,c){if(!ne(s))return gt(e,t,n,o,r,s,a,i,c);const l=oe(s),u=r,f=u.length;for(let r=0;r<f;r++)await gt(e,t,n,o,u[r],l,a,i,c);return!0}async function bt(e,t,n,o){if(!(n in t.tokenOccurrences))return[];const{node:r,type:s}=t.indexes[n];if("Radix"!==s)throw H("WRONG_SEARCH_PROPERTY_TYPE",n);const{exact:a,tolerance:i}=e.params,c=Ze(r,{term:o,exact:a,tolerance:i}),l=new Set;for(const e in c){if(j(c,e))for(const t of c[e])l.add(t)}return e.index.calculateResultScores(e,t,n,o,Array.from(l))}async function wt(e,t,n){const o=Object.keys(n),r=o.reduce(((e,t)=>({[t]:[],...e})),{});for(const s of o){const o=n[s];if(void 0===t.indexes[s])throw H("UNKNOWN_FILTER_PROPERTY",s);const{node:a,type:i,isArray:c}=t.indexes[s];if("Bool"===i){const e=a[o.toString()];R(r[s],e);continue}if("BKD"===i){let e;if("radius"in o)e="radius";else{if(!("polygon"in o))throw new Error(`Invalid operation ${o}`);e="polygon"}if("radius"===e){const{value:t,coordinates:n,unit:i="m",inside:c=!0,highPrecision:l=!1}=o[e],u=G(t,i),f=Qe(a.root,n,u,c,void 0,l);R(r[s],f.map((({docIDs:e})=>e)).flat())}else{const{coordinates:t,inside:n=!0,highPrecision:i=!1}=o[e],c=et(a.root,t,n,void 0,i);R(r[s],c.map((({docIDs:e})=>e)).flat())}continue}if("Radix"===i&&("string"==typeof o||Array.isArray(o))){for(const t of[o].flat()){const n=await e.tokenizer.tokenize(t,e.language,s);for(const e of n){const t=Ze(a,{term:e,exact:!0});R(r[s],Object.values(t).flat())}}continue}const l=Object.keys(o);if(l.length>1)throw H("INVALID_FILTER_OPERATION",l.length);if("Flat"!==i){if("AVL"===i){const e=l[0],t=o[e];let n=[];switch(e){case"gt":n=Me(a,t,!1);break;case"gte":n=Me(a,t,!0);break;case"lt":n=Re(a,t,!1);break;case"lte":n=Re(a,t,!0);break;case"eq":n=Ce(a,t)??[];break;case"between":{const[e,o]=t;n=Ne(a,e,o);break}}R(r[s],n)}}else R(r[s],c?je(a,o):Le(a,o))}return W(Object.values(r))}async function vt(e){return e.searchableProperties}async function It(e){return e.searchablePropertiesWithTypes}function St(e){const t=He(e.e,e.s,e.k);t.d=e.d,t.w=e.w;for(const n of Object.keys(e.c))t.c[n]=St(e.c[n]);return t}function Tt(e){return{numberToDocumentId:new Map(e)}}function Dt(e){return Array.from(e.numberToDocumentId.entries())}async function _t(e,t){const{indexes:n,vectorIndexes:o,searchableProperties:r,searchablePropertiesWithTypes:s,frequencies:a,tokenOccurrences:i,avgFieldLength:c,fieldLengths:l}=t,u={},f={};for(const e of Object.keys(n)){const{node:t,type:o,isArray:r}=n[e];switch(o){case"Radix":u[e]={type:"Radix",node:St(t),isArray:r};break;case"Flat":u[e]={type:"Flat",node:Tt(t),isArray:r};break;default:u[e]=n[e]}}for(const e of Object.keys(o)){const t=o[e].vectors;for(const e in t)t[e]=[t[e][0],new Float32Array(t[e][1])];f[e]={size:o[e].size,vectors:t}}return{sharedInternalDocumentStore:e,indexes:u,vectorIndexes:f,searchableProperties:r,searchablePropertiesWithTypes:s,frequencies:a,tokenOccurrences:i,avgFieldLength:c,fieldLengths:l}}async function Ot(e){const{indexes:t,vectorIndexes:n,searchableProperties:o,searchablePropertiesWithTypes:r,frequencies:s,tokenOccurrences:a,avgFieldLength:i,fieldLengths:c}=e,l={};for(const e of Object.keys(n)){const t=n[e].vectors;for(const e in t)t[e]=[t[e][0],Array.from(t[e][1])];l[e]={size:n[e].size,vectors:t}}const u={};for(const e of Object.keys(t)){const{type:n,node:o,isArray:r}=t[e];"Flat"===n?u[e]={type:"Flat",node:Dt(o),isArray:r}:u[e]=t[e]}return{indexes:u,vectorIndexes:l,searchableProperties:o,searchablePropertiesWithTypes:r,frequencies:s,tokenOccurrences:a,avgFieldLength:i,fieldLengths:c}}async function At(){return{create:ht,insert:mt,remove:yt,insertDocumentScoreParameters:ct,insertTokenScoreParameters:lt,removeDocumentScoreParameters:ut,removeTokenScoreParameters:ft,calculateResultScores:dt,search:bt,searchByWhereClause:wt,getSearchableProperties:vt,getSearchablePropertiesWithTypes:It,load:_t,save:Ot}}var kt=Object.freeze({__proto__:null,insertDocumentScoreParameters:ct,insertTokenScoreParameters:lt,removeDocumentScoreParameters:ut,removeTokenScoreParameters:ft,calculateResultScores:dt,create:ht,insert:mt,remove:yt,search:bt,searchByWhereClause:wt,getSearchableProperties:vt,getSearchablePropertiesWithTypes:It,load:_t,save:Ot,createIndex:At});function xt(e,t,n,o,r){const s={language:e.tokenizer.language,sharedInternalDocumentStore:t,enabled:!0,isSorted:!0,sortableProperties:[],sortablePropertiesWithTypes:{},sorts:{}};for(const[a,i]of Object.entries(n)){const n=`${r}${r?".":""}${a}`;if(!o.includes(n))if("object"!=typeof i||Array.isArray(i)){if(!te(i))switch(i){case"boolean":case"number":case"string":s.sortableProperties.push(n),s.sortablePropertiesWithTypes[n]=i,s.sorts[n]={docs:new Map,orderedDocsToRemove:new Map,orderedDocs:[],type:i};break;case"geopoint":case"enum":case"enum[]":case"boolean[]":case"number[]":case"string[]":continue;default:throw H("INVALID_SORT_SCHEMA_TYPE",Array.isArray(i)?"array":i,n)}}else{const r=xt(e,t,i,o,n);R(s.sortableProperties,r.sortableProperties),s.sorts={...s.sorts,...r.sorts},s.sortablePropertiesWithTypes={...s.sortablePropertiesWithTypes,...r.sortablePropertiesWithTypes}}}return s}async function Et(e,t,n,o){return!1!==(null==o?void 0:o.enabled)?xt(e,t,n,(o||{}).unsortableProperties||[],""):{disabled:!0}}async function Pt(e,t,n,o){if(!e.enabled)return;e.isSorted=!1;const r=ce(e.sharedInternalDocumentStore,n),s=e.sorts[t];s.orderedDocsToRemove.has(r)&&Ct(e,t),s.docs.set(r,s.orderedDocs.length),s.orderedDocs.push([r,o])}function Nt(e){if(e.isSorted||!e.enabled)return;const t=Object.keys(e.sorts);for(const n of t)Ut(e,n);e.isSorted=!0}function Mt(t,o,r){return o[1].localeCompare(r[1],function(t){return void 0!==t&&n.includes(t)?e[t]:void 0}(t))}function Rt(e,t){return e[1]-t[1]}function zt(e,t){return t[1]?-1:1}function Ut(e,t){const n=e.sorts[t];let o;switch(n.type){case"string":o=Mt.bind(null,e.language);break;case"number":o=Rt.bind(null);break;case"boolean":o=zt.bind(null)}n.orderedDocs.sort(o);const r=n.orderedDocs.length;for(let e=0;e<r;e++){const t=n.orderedDocs[e][0];n.docs.set(t,e)}}function Ct(e,t){const n=e.sorts[t];n.orderedDocsToRemove.size&&(n.orderedDocs=n.orderedDocs.filter((e=>!n.orderedDocsToRemove.has(e[0]))),n.orderedDocsToRemove.clear())}async function Lt(e,t,n){if(!e.enabled)return;const o=e.sorts[t],r=ce(e.sharedInternalDocumentStore,n);o.docs.get(r)&&(o.docs.delete(r),o.orderedDocsToRemove.set(r,!0))}async function jt(e,t,n){if(!e.enabled)throw H("SORT_DISABLED");const o=n.property,r="DESC"===n.order,s=e.sorts[o];if(!s)throw H("UNABLE_TO_SORT_ON_UNKNOWN_FIELD",o,e.sortableProperties.join(", "));return Ct(e,o),Nt(e),t.sort(((t,n)=>{const o=s.docs.get(ce(e.sharedInternalDocumentStore,t[0])),a=s.docs.get(ce(e.sharedInternalDocumentStore,n[0])),i=void 0!==o,c=void 0!==a;return i||c?i?c?r?a-o:o-a:-1:1:0})),t}async function Bt(e){return e.enabled?e.sortableProperties:[]}async function Wt(e){return e.enabled?e.sortablePropertiesWithTypes:{}}async function Vt(e,t){const n=t;if(!n.enabled)return{enabled:!1};const o=Object.keys(n.sorts).reduce(((e,t)=>{const{docs:o,orderedDocs:r,type:s}=n.sorts[t];return e[t]={docs:new Map(Object.entries(o).map((([e,t])=>[+e,t]))),orderedDocsToRemove:new Map,orderedDocs:r,type:s},e}),{});return{sharedInternalDocumentStore:e,language:n.language,sortableProperties:n.sortableProperties,sortablePropertiesWithTypes:n.sortablePropertiesWithTypes,sorts:o,enabled:!0,isSorted:n.isSorted}}async function Ft(e){if(!e.enabled)return{enabled:!1};!function(e){const t=Object.keys(e.sorts);for(const n of t)Ct(e,n)}(e),Nt(e);const t=Object.keys(e.sorts).reduce(((t,n)=>{const{docs:o,orderedDocs:r,type:s}=e.sorts[n];return t[n]={docs:Object.fromEntries(o.entries()),orderedDocs:r,type:s},t}),{});return{language:e.language,sortableProperties:e.sortableProperties,sortablePropertiesWithTypes:e.sortablePropertiesWithTypes,sorts:t,enabled:e.enabled,isSorted:e.isSorted}}async function $t(){return{create:Et,insert:Pt,remove:Lt,save:Ft,load:Vt,sortBy:jt,getSortableProperties:Bt,getSortablePropertiesWithTypes:Wt}}var Gt=Object.freeze({__proto__:null,load:Vt,save:Ft,createSorter:$t});const Yt=[65,65,65,65,65,65,65,67,69,69,69,69,73,73,73,73,69,78,79,79,79,79,79,null,79,85,85,85,85,89,80,115,97,97,97,97,97,97,97,99,101,101,101,101,105,105,105,105,101,110,111,111,111,111,111,null,111,117,117,117,117,121,112,121,65,97,65,97,65,97,67,99,67,99,67,99,67,99,68,100,68,100,69,101,69,101,69,101,69,101,69,101,71,103,71,103,71,103,71,103,72,104,72,104,73,105,73,105,73,105,73,105,73,105,73,105,74,106,75,107,107,76,108,76,108,76,108,76,108,76,108,78,110,78,110,78,110,110,78,110,79,111,79,111,79,111,79,111,82,114,82,114,82,114,83,115,83,115,83,115,83,115,84,116,84,116,84,116,85,117,85,117,85,117,85,117,85,117,85,117,87,119,89,121,89,90,122,90,122,90,122,115];const qt={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},Ht={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},Kt="[aeiouy]",Xt="[^aeiou][^aeiouy]*",Zt=Kt+"[aeiou]*",Jt="^("+Xt+")?"+Zt+Xt,Qt="^("+Xt+")?"+Zt+Xt+"("+Zt+")?$",en="^("+Xt+")?"+Zt+Xt+Zt+Xt,tn="^("+Xt+")?"+Kt;function nn(e){let t,n,o,r,s,a;if(e.length<3)return e;const i=e.substring(0,1);if("y"==i&&(e=i.toUpperCase()+e.substring(1)),o=/^(.+?)(ss|i)es$/,r=/^(.+?)([^s])s$/,o.test(e)?e=e.replace(o,"$1$2"):r.test(e)&&(e=e.replace(r,"$1$2")),o=/^(.+?)eed$/,r=/^(.+?)(ed|ing)$/,o.test(e)){const t=o.exec(e);o=new RegExp(Jt),o.test(t[1])&&(o=/.$/,e=e.replace(o,""))}else if(r.test(e)){t=r.exec(e)[1],r=new RegExp(tn),r.test(t)&&(e=t,r=/(at|bl|iz)$/,s=new RegExp("([^aeiouylsz])\\1$"),a=new RegExp("^"+Xt+Kt+"[^aeiouwxy]$"),r.test(e)?e+="e":s.test(e)?(o=/.$/,e=e.replace(o,"")):a.test(e)&&(e+="e"))}if(o=/^(.+?)y$/,o.test(e)){const n=o.exec(e);t=null==n?void 0:n[1],o=new RegExp(tn),t&&o.test(t)&&(e=t+"i")}if(o=/^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/,o.test(e)){const r=o.exec(e);t=null==r?void 0:r[1],n=null==r?void 0:r[2],o=new RegExp(Jt),t&&o.test(t)&&(e=t+qt[n])}if(o=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/,o.test(e)){const r=o.exec(e);t=null==r?void 0:r[1],n=null==r?void 0:r[2],o=new RegExp(Jt),t&&o.test(t)&&(e=t+Ht[n])}if(o=/^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/,r=/^(.+?)(s|t)(ion)$/,o.test(e)){const n=o.exec(e);t=null==n?void 0:n[1],o=new RegExp(en),t&&o.test(t)&&(e=t)}else if(r.test(e)){const n=r.exec(e);t=(null==n?void 0:n[1])??""+(null==n?void 0:n[2])??"",r=new RegExp(en),r.test(t)&&(e=t)}if(o=/^(.+?)e$/,o.test(e)){const n=o.exec(e);t=null==n?void 0:n[1],o=new RegExp(en),r=new RegExp(Qt),s=new RegExp("^"+Xt+Kt+"[^aeiouwxy]$"),t&&(o.test(t)||r.test(t)&&!s.test(t))&&(e=t)}return o=/ll$/,r=new RegExp(en),o.test(e)&&r.test(e)&&(o=/.$/,e=e.replace(o,"")),"y"==i&&(e=i.toLowerCase()+e.substring(1)),e}function on(e,t){var n;const o=`${this.language}:${e}:${t}`;return this.normalizationCache.has(o)?this.normalizationCache.get(o):(null===(n=this.stopWords)||void 0===n?void 0:n.includes(t))?(this.normalizationCache.set(o,""),""):(this.stemmer&&!this.stemmerSkipProperties.has(e)&&(t=this.stemmer(t)),t=function(e){const t=[];for(let o=0;o<e.length;o++)t[o]=(n=e.charCodeAt(o))<192||n>383?n:Yt[n-192]||n;var n;return String.fromCharCode(...t)}(t),this.normalizationCache.set(o,t),t)}function rn(e,n,o){if(n&&n!==this.language)throw H("LANGUAGE_NOT_SUPPORTED",n);if("string"!=typeof e)return[e];let r;if(o&&this.tokenizeSkipProperties.has(o))r=[this.normalizeToken.bind(this,o??"")(e)];else{const n=t[this.language];r=e.toLowerCase().split(n).map(this.normalizeToken.bind(this,o??"")).filter(Boolean)}const s=function(e){for(;""===e[e.length-1];)e.pop();for(;""===e[0];)e.shift();return e}(r);return this.allowDuplicates?s:Array.from(new Set(s))}async function sn(e={}){if(e.language){if(!n.includes(e.language))throw H("LANGUAGE_NOT_SUPPORTED",e.language)}else e.language="english";let t,o;if(e.stemming||e.stemmer&&!("stemming"in e))if(e.stemmer){if("function"!=typeof e.stemmer)throw H("INVALID_STEMMER_FUNCTION_TYPE");t=e.stemmer}else{if("english"!==e.language)throw H("MISSING_STEMMER",e.language);t=nn}if(!1!==e.stopWords){if(o=[],Array.isArray(e.stopWords))o=e.stopWords;else if("function"==typeof e.stopWords)o=await e.stopWords(o);else if(e.stopWords)throw H("CUSTOM_STOP_WORDS_MUST_BE_FUNCTION_OR_ARRAY");if(!Array.isArray(o))throw H("CUSTOM_STOP_WORDS_MUST_BE_FUNCTION_OR_ARRAY");for(const e of o)if("string"!=typeof e)throw H("CUSTOM_STOP_WORDS_MUST_BE_FUNCTION_OR_ARRAY")}const r={tokenize:rn,language:e.language,stemmer:t,stemmerSkipProperties:new Set(e.stemmerSkipProperties?[e.stemmerSkipProperties].flat():[]),tokenizeSkipProperties:new Set(e.tokenizeSkipProperties?[e.tokenizeSkipProperties].flat():[]),stopWords:o,allowDuplicates:Boolean(e.allowDuplicates),normalizeToken:on,normalizationCache:new Map};return r.tokenize=rn.bind(r),r.normalizeToken=on,r}var an=Object.freeze({__proto__:null,normalizeToken:on,createTokenizer:sn});function cn(e){const t={formatElapsedTime:K,getDocumentIndexId:X,getDocumentProperties:V,validateSchema:Z};for(const n of _e){const o=n;if(e[o]){if("function"!=typeof e[o])throw H("COMPONENT_MUST_BE_FUNCTION",o)}else e[o]=t[o]}for(const t of Object.keys(e))if(!De.includes(t)&&!_e.includes(t))throw H("UNSUPPORTED_COMPONENT",t)}async function ln({schema:e,sort:t,language:n,components:o,id:r,plugins:s}){o||(o={}),r||(r=await L());let a=o.tokenizer,i=o.index,c=o.documentsStore,l=o.sorter;if(a)if(a.tokenize){a=a}else a=await sn(a);else a=await sn({language:n??"english"});if(o.tokenizer&&n)throw H("NO_LANGUAGE_WITH_CUSTOM_TOKENIZER");const u=se();i||=await At(),l||=await $t(),c||=await ve(),cn(o);const{getDocumentProperties:f,getDocumentIndexId:d,validateSchema:h,formatElapsedTime:p}=o,m={data:{},caches:{},schema:e,tokenizer:a,index:i,sorter:l,documentsStore:c,internalDocumentIDStore:u,getDocumentProperties:f,getDocumentIndexId:d,validateSchema:h,beforeInsert:[],afterInsert:[],beforeRemove:[],afterRemove:[],beforeUpdate:[],afterUpdate:[],beforeSearch:[],afterSearch:[],beforeInsertMultiple:[],afterInsertMultiple:[],beforeRemoveMultiple:[],afterRemoveMultiple:[],afterUpdateMultiple:[],beforeUpdateMultiple:[],afterCreate:[],formatElapsedTime:p,id:r,plugins:s,version:"2.0.15"};m.data={index:await m.index.create(m,u,e),docs:await m.documentsStore.create(m,u),sorting:await m.sorter.create(m,u,e,t)};for(const e of Se)m[e]=(m[e]??[]).concat(await Te(m,e));const g=m.afterCreate;return g&&await async function(e,t){const n=e.length;for(let o=0;o<n;o++)await e[o](t)}(g,m),m}function un(e,t){return e.documentsStore.get(e.data.docs,t)}function fn(e){return e.documentsStore.count(e.data.docs)}var dn=Object.freeze({__proto__:null,documentsStore:Ie,index:kt,tokenizer:an,sorter:Gt,internalDocumentIDStore:ue,getDocumentProperties:V,formatElapsedTime:K,getDocumentIndexId:X,validateSchema:Z,isGeoPointType:ee,isVectorType:te,isArrayType:ne,getInnerType:oe,getVectorSize:re});const hn=Symbol("orama.insertions"),pn=Symbol("orama.removals");var mn;const gn=(null===(mn=globalThis.process)||void 0===mn?void 0:mn.emitWarning)??function(e,t){console.warn(`[WARNING] [${t.code}] ${e}`)};async function yn(e,t,n,o){const r=await e.validateSchema(t,e.schema);if(r)throw H("SCHEMA_VALIDATION_FAILURE",r);return async function(e,t,n,o){const{index:r,docs:s}=e.data,a=await e.getDocumentIndexId(t);if("string"!=typeof a)throw H("DOCUMENT_ID_MUST_BE_STRING",typeof a);if(!await e.documentsStore.store(s,a,t))throw H("DOCUMENT_ALREADY_EXISTS",a);const i=await e.documentsStore.count(s);o||await Oe(e.beforeInsert,e,a,t);const c=await e.index.getSearchableProperties(r),l=await e.index.getSearchablePropertiesWithTypes(r),u=await e.getDocumentProperties(t,c);for(const[e,t]of Object.entries(u)){if(void 0===t)continue;const n=typeof t,o=l[e];if((!ee(o)||"object"!=typeof t||"number"!=typeof t.lon||"number"!=typeof t.lat)&&!(te(o)&&Array.isArray(t)||ne(o)&&Array.isArray(t)||bn.has(o)&&wn.has(n)||n===o))throw H("INVALID_DOCUMENT_PROPERTY",e,o,n)}for(const t of c){var f,d,h,p;const o=u[t];if(void 0===o)continue;const r=l[t];await(null===(d=(f=e.index).beforeInsert)||void 0===d?void 0:d.call(f,e.data.index,t,a,o,r,n,e.tokenizer,i)),await e.index.insert(e.index,e.data.index,t,a,o,r,n,e.tokenizer,i),await(null===(p=(h=e.index).afterInsert)||void 0===p?void 0:p.call(h,e.data.index,t,a,o,r,n,e.tokenizer,i))}const m=await e.sorter.getSortableProperties(e.data.sorting),g=await e.sorter.getSortablePropertiesWithTypes(e.data.sorting),y=await e.getDocumentProperties(t,m);for(const t of m){const o=y[t];if(void 0===o)continue;const r=g[t];await e.sorter.insert(e.data.sorting,t,a,o,r,n)}o||await Oe(e.afterInsert,e,a,t);return function(e){"number"!=typeof e[hn]&&(queueMicrotask((()=>{e[hn]=void 0})),e[hn]=0),e[hn]>1e3?(gn("Orama's insert operation is synchronous. Please avoid inserting a large number of document in a single operation in order not to block the main thread or, in alternative, please use insertMultiple.",{code:"ORAMA0001"}),e[hn]=-1):e[hn]>=0&&e[hn]++}(e),a}(e,t,n,o)}const bn=new Set(["enum","enum[]"]),wn=new Set(["string","number"]);async function vn(e,t,n,o,r,s){r||await Ae(e.beforeInsertMultiple,e,t);const a=t.length,i=e.schema;for(let n=0;n<a;n++){const o=await e.validateSchema(t[n],i);if(o)throw H("SCHEMA_VALIDATION_FAILURE",o)}return In(e,t,n,o,r,s)}async function In(e,t,n,o,r,s){n||(n=1e3),s??=0;const a=[];return await new Promise(((i,c)=>{let l=0;setTimeout((async function u(){const f=t.slice(l*n,++l*n);if(!f.length)return i();for(const t of f)try{const n=await yn(e,t,o,r);a.push(n)}catch(e){c(e)}setTimeout(u,s)}),s)})),r||await Ae(e.afterInsertMultiple,e,t),a}async function Sn(e,t,n,o){let r=!0;const{index:s,docs:a}=e.data,i=await e.documentsStore.get(a,t);if(!i)return!1;const c=le(e.internalDocumentIDStore,ce(e.internalDocumentIDStore,t)),l=await e.documentsStore.count(a);o||await Oe(e.beforeRemove,e,c);const u=await e.index.getSearchableProperties(s),f=await e.index.getSearchablePropertiesWithTypes(s),d=await e.getDocumentProperties(i,u);for(const o of u){var h,p,m,g;const s=d[o];if(void 0===s)continue;const a=f[o];await(null===(p=(h=e.index).beforeRemove)||void 0===p?void 0:p.call(h,e.data.index,o,c,s,a,n,e.tokenizer,l)),await e.index.remove(e.index,e.data.index,o,t,s,a,n,e.tokenizer,l)||(r=!1),await(null===(g=(m=e.index).afterRemove)||void 0===g?void 0:g.call(m,e.data.index,o,c,s,a,n,e.tokenizer,l))}const y=await e.sorter.getSortableProperties(e.data.sorting),b=await e.getDocumentProperties(i,y);for(const n of y)void 0!==b[n]&&await e.sorter.remove(e.data.sorting,n,t);return o||await Oe(e.afterRemove,e,c),await e.documentsStore.remove(e.data.docs,t),function(e){"number"!=typeof e[pn]&&(queueMicrotask((()=>{e[pn]=void 0})),e[pn]=0),e[pn]>1e3?(gn("Orama's remove operation is synchronous. Please avoid removing a large number of document in a single operation in order not to block the main thread, in alternative, please use updateMultiple.",{code:"ORAMA0002"}),e[pn]=-1):e[pn]>=0&&e[pn]++}(e),r}async function Tn(e,t,n,o,r){let s=0;n||(n=1e3);const a=r?[]:t.map((t=>le(e.internalDocumentIDStore,ce(e.internalDocumentIDStore,t))));return r||await Ae(e.beforeRemoveMultiple,e,a),await new Promise(((a,i)=>{let c=0;setTimeout((async function l(){const u=t.slice(c*n,++c*n);if(!u.length)return a();for(const t of u)try{await Sn(e,t,o,r)&&s++}catch(e){i(e)}setTimeout(l,0)}),0)})),r||await Ae(e.afterRemoveMultiple,e,a),s}const Dn="fulltext";function _n(e,t){const n=new Map,o=[];for(const t of e)n.set(t,!0);for(const e of t){const[t]=e;n.has(t)&&(o.push(e),n.delete(t))}return o}function On(e="desc"){return"asc"===e.toLowerCase()?(e,t)=>e[1]-t[1]:(e,t)=>t[1]-e[1]}async function An(e,t,n){const o={},r=t.map((([e])=>e)),s=await e.documentsStore.getMultiple(e.data.docs,r),a=Object.keys(n),i=await e.index.getSearchablePropertiesWithTypes(e.data.index);for(const e of a){let t;if("number"===i[e]){const{ranges:o}=n[e],r=o.length,s=Array.from({length:r});for(let e=0;e<r;e++){const t=o[e];s[e]=[`${t.from}-${t.to}`,0]}t=Object.fromEntries(s)}o[e]={count:0,values:t??{}}}const c=s.length;for(let e=0;e<c;e++){const t=s[e];for(const e of a){const r=e.includes(".")?await F(t,e):t[e],s=i[e],a=o[e].values;switch(s){case"number":kn(n[e].ranges,a,r);break;case"number[]":{const t=new Set,o=n[e].ranges;for(const e of r)kn(o,a,e,t);break}case"boolean":case"enum":case"string":xn(a,r,s);break;case"boolean[]":case"enum[]":case"string[]":{const e=new Set,t="boolean[]"===s?"boolean":"string";for(const n of r)xn(a,n,t,e);break}default:throw H("FACET_NOT_SUPPORTED",s)}}}for(const e of a)if(o[e].count=Object.keys(o[e].values).length,"string"===i[e]){const t=n[e],r=On(t.sort);o[e].values=Object.fromEntries(Object.entries(o[e].values).sort(r).slice(t.offset??0,t.limit??10))}return o}function kn(e,t,n,o){for(const r of e){const e=`${r.from}-${r.to}`;(null==o?void 0:o.has(e))||n>=r.from&&n<=r.to&&(void 0===t[e]?t[e]=1:(t[e]++,null==o||o.add(e)))}}function xn(e,t,n,o){const r=(null==t?void 0:t.toString())??("boolean"===n?"false":"");(null==o?void 0:o.has(r))||(e[r]=(e[r]??0)+1,null==o||o.add(r))}const En={reducer:(e,t,n,o)=>(t[o]=n,t),getInitialValue:e=>Array.from({length:e})},Pn=["string","number","boolean"];async function Nn(e,t,n){const o=n.properties,r=o.length,s=await e.index.getSearchablePropertiesWithTypes(e.data.index);for(let e=0;e<r;e++){const t=o[e];if(void 0===s[t])throw H("UNKNOWN_GROUP_BY_PROPERTY",t);if(!Pn.includes(s[t]))throw H("INVALID_GROUP_BY_PROPERTY",t,Pn.join(", "),s[t])}const a=t.map((([t])=>le(e.internalDocumentIDStore,t))),i=await e.documentsStore.getMultiple(e.data.docs,a),c=i.length,l=n.maxResult||Number.MAX_SAFE_INTEGER,u=[],f={};for(let e=0;e<r;e++){const t=o[e],n={property:t,perValue:{}},r=new Set;for(let e=0;e<c;e++){const o=i[e],s=await F(o,t);if(void 0===s)continue;const a="boolean"!=typeof s?s:""+s,c=n.perValue[a]??{indexes:[],count:0};c.count>=l||(c.indexes.push(e),c.count++,n.perValue[a]=c,r.add(s))}u.push(Array.from(r)),f[t]=n}const d=Mn(u),h=d.length,p=[];for(let e=0;e<h;e++){const t=d[e],n=t.length,r={values:[],indexes:[]},s=[];for(let e=0;e<n;e++){const n=t[e],a=o[e];s.push(f[a].perValue["boolean"!=typeof n?n:""+n].indexes),r.values.push(n)}r.indexes=W(s).sort(((e,t)=>e-t)),0!==r.indexes.length&&p.push(r)}const m=p.length,g=Array.from({length:m});for(let e=0;e<m;e++){const o=p[e],r=n.reduce||En,s=o.indexes.map((e=>({id:a[e],score:t[e][1],document:i[e]}))),c=r.reducer.bind(null,o.values),l=r.getInitialValue(o.indexes.length),u=s.reduce(c,l);g[e]={values:o.values,result:u}}return g}function Mn(e,t=0){if(t+1===e.length)return e[t].map((e=>[e]));const n=e[t],o=Mn(e,t+1),r=[];for(const e of n)for(const t of o){const n=[e];R(n,t),r.push(n)}return r}async function Rn(e,t,n){const o=await C();e.beforeSearch&&await xe(e.beforeSearch,e,t,n),t.relevance=Object.assign(Vn,t.relevance??{});const r=Object.keys(e.data.index.vectorIndexes),s=t.facets&&Object.keys(t.facets).length>0,{limit:a=10,offset:i=0,term:c,properties:l,threshold:u=1,distinctOn:f,includeVectors:d=!1}=t,h=!0===t.preflight,{index:p,docs:m}=e.data,g=await e.tokenizer.tokenize(c??"",n);let y=e.caches.propertiesToSearch;if(!y){const t=await e.index.getSearchablePropertiesWithTypes(p);y=await e.index.getSearchableProperties(p),y=y.filter((e=>t[e].startsWith("string"))),e.caches.propertiesToSearch=y}if(l&&"*"!==l){for(const e of l)if(!y.includes(e))throw H("UNKNOWN_INDEX",e,y.join(", "));y=y.filter((e=>l.includes(e)))}const b=await Fn(e.tokenizer,e.index,e.documentsStore,n,t,y,g,await e.documentsStore.count(m),o),w=Object.keys(t.where??{}).length>0;let v=[];w&&(v=await e.index.searchByWhereClause(b,p,t.where));const I=g.length;if(I||l&&l.length>0){const n=y.length;for(let o=0;o<n;o++){var S;const n=y[o];if(0!==I)for(let t=0;t<I;t++){const o=g[t],r=await e.index.search(b,p,n,o);R(b.indexMap[n][o],r)}else{b.indexMap[n][""]=[];const t=await e.index.search(b,p,n,"");R(b.indexMap[n][""],t)}const r=b.indexMap[n],s=Object.values(r);b.docsIntersection[n]=rt(s,(null==t||null===(S=t.boost)||void 0===S?void 0:S[n])??1,u,I);const a=b.docsIntersection[n],i=a.length;for(let e=0;e<i;e++){const[t,n]=a[e],o=b.uniqueDocsIDs[t];b.uniqueDocsIDs[t]=o?o+n+.5:n}}}else 0===g.length&&c?b.uniqueDocsIDs={}:b.uniqueDocsIDs=Object.fromEntries(Object.keys(await e.documentsStore.getAll(e.data.docs)).map((e=>[e,0])));let T,D=Object.entries(b.uniqueDocsIDs).map((([e,t])=>[+e,t]));if(w&&(D=_n(v,D)),t.sortBy)if("function"==typeof t.sortBy){const n=D.map((([e])=>e)),o=(await e.documentsStore.getMultiple(e.data.docs,n)).map(((e,t)=>[D[t][0],D[t][1],e]));o.sort(t.sortBy),D=o.map((([e,t])=>[e,t]))}else D=await e.sorter.sortBy(e.data.sorting,D,t.sortBy).then((t=>t.map((([t,n])=>[ce(e.internalDocumentIDStore,t),n]))));else D=D.sort(B);h||(T=await(f?async function(e,t,n,o,r){const s=e.data.docs,a=new Map,i=[],c=new Set,l=t.length;let u=0;for(let f=0;f<l;f++){const l=t[f];if(void 0===l)continue;const[d,h]=l;if(c.has(d))continue;const p=await e.documentsStore.get(s,d),m=await F(p,r);if(void 0!==m&&!a.has(m)&&(a.set(m,!0),u++,!(u<=n)&&(i.push({id:le(e.internalDocumentIDStore,d),score:h,document:p}),c.add(d),u>=n+o)))break}return i}(e,D,i,a,f):Gn(e,D,i,a)));const _={elapsed:{formatted:"",raw:0},hits:[],count:D.length};if(void 0!==T&&(_.hits=T.filter(Boolean),d||Y(_,r)),s){const n=await An(e,D,t.facets);_.facets=n}return t.groupBy&&(_.groups=await Nn(e,D,t.groupBy)),e.afterSearch&&await ke(e.afterSearch,e,t,n,_),_.elapsed=await e.formatElapsedTime(await C()-b.timeStart),_}async function zn(e,t,n="english"){const o=await C();e.beforeSearch&&await xe(e.beforeSearch,e,t,n);const{vector:r}=t;if(r&&(!("value"in r)||!("property"in r)))throw H("INVALID_VECTOR_INPUT",Object.keys(r).join(", "));const{limit:s=10,offset:a=0,includeVectors:i=!1}=t,c=e.data.index.vectorIndexes[r.property],l=c.size,u=c.vectors,f=t.facets&&Object.keys(t.facets).length>0,d=Object.keys(t.where??{}).length>0,{index:h,docs:p}=e.data;if((null==r?void 0:r.value.length)!==l)throw H("INVALID_INPUT_VECTOR",null==r?void 0:r.property,l,null==r?void 0:r.value.length);r instanceof Float32Array||(r.value=new Float32Array(r.value));let m=it(r.value,u,l,t.similarity).map((([t,n])=>[ce(e.internalDocumentIDStore,t),n])),g=e.caches.propertiesToSearch;if(!g){const t=await e.index.getSearchablePropertiesWithTypes(h);g=await e.index.getSearchableProperties(h),g=g.filter((e=>t[e].startsWith("string"))),e.caches.propertiesToSearch=g}const y=await Fn(e.tokenizer,e.index,e.documentsStore,n,t,g,[],await e.documentsStore.count(p),o);let b=[];d&&(b=await e.index.searchByWhereClause(y,h,t.where),m=_n(b,m));let w=[];if(f){w=await An(e,m,t.facets)}const v=Array.from({length:s});for(let t=0;t<s;t++){const n=m[t+a];if(!n)break;const o=e.data.docs.docs[n[0]];if(o){i||(o[r.property]=null);const s={id:le(e.internalDocumentIDStore,n[0]),score:n[1],document:o};v[t]=s}}let I=[];t.groupBy&&(I=await Nn(e,m,t.groupBy)),e.afterSearch&&await ke(e.afterSearch,e,t,n,m);const S=await C()-o;return{count:m.length,hits:v.filter(Boolean),elapsed:{raw:Number(S),formatted:await U(S)},...w?{facets:w}:{},...I?{groups:I}:{}}}async function Un(e,t,n){const o=await C();e.beforeSearch&&await xe(e.beforeSearch,e,t,n);const{offset:r=0,limit:s=10,includeVectors:a=!1}=t,i=t.facets&&Object.keys(t.facets).length>0,[c,l]=await Promise.all([Cn(e,t,n),Ln(e,t)]),{index:u,docs:f}=e.data,d=t.hybridWeights;let h=function(e,t,n,o){const r=Math.max(...e.map((([,e])=>e))),s=Math.max(...t.map((([,e])=>e))),a=o&&o.text&&o.vector,{text:i,vector:c}=a?o:{text:.5,vector:.5},l=new Map,u=e.length;for(let t=0;t<u;t++){const n=Wn(Bn(e[t][1],r),0,i,c);l.set(e[t][0],n)}const f=t.length;for(let e=0;e<f;e++){const n=Bn(t[e][1],s),o=t[e][0];if(l.has(o)){let e=l.get(o);l.set(o,e+=Wn(0,n,i,c))}else l.set(o,Wn(0,n,i,c))}return[...l].sort(((e,t)=>t[1]-e[1]))}(c,l,t.term,d);const p=await e.tokenizer.tokenize(t.term??"",n);let m=e.caches.propertiesToSearch;if(!m){const t=await e.index.getSearchablePropertiesWithTypes(u);m=await e.index.getSearchableProperties(u),m=m.filter((e=>t[e].startsWith("string"))),e.caches.propertiesToSearch=m}if(t.properties&&"*"!==t.properties){for(const e of t.properties)if(!m.includes(e))throw H("UNKNOWN_INDEX",e,m.join(", "));m=m.filter((e=>t.properties.includes(e)))}const g=await Fn(e.tokenizer,e.index,e.documentsStore,n,t,m,p,await e.documentsStore.count(f),o);let y,b,w=[];if(Object.keys(t.where??{}).length>0&&(w=await e.index.searchByWhereClause(g,u,t.where),h=_n(w,h).slice(r,r+s)),i){y=await An(e,h,t.facets)}t.groupBy&&(b=await Nn(e,h,t.groupBy));const v=(await Gn(e,h,r,s)).filter(Boolean);e.afterSearch&&await ke(e.afterSearch,e,t,n,v);const I=await C(),S={count:h.length,elapsed:{raw:Number(I-o),formatted:await U(I-o)},hits:v,...y?{facets:y}:{},...b?{groups:b}:{}};if(!a){Y(S,Object.keys(e.data.index.vectorIndexes))}return S}async function Cn(e,t,n){const o=await C();t.relevance=Object.assign(Vn,t.relevance??{});const{term:r="",properties:s,threshold:a=1}=t,{index:i,docs:c}=e.data,l=await e.tokenizer.tokenize(r,n);let u=e.caches.propertiesToSearch;if(!u){const t=await e.index.getSearchablePropertiesWithTypes(i);u=await e.index.getSearchableProperties(i),u=u.filter((e=>t[e].startsWith("string"))),e.caches.propertiesToSearch=u}if(s&&"*"!==s){for(const e of s)if(!u.includes(e))throw H("UNKNOWN_INDEX",e,u.join(", "));u=u.filter((e=>s.includes(e)))}const f=await Fn(e.tokenizer,e.index,e.documentsStore,n,t,u,l,await e.documentsStore.count(c),o),d=l.length;if(d||s&&s.length>0){const n=u.length;for(let o=0;o<n;o++){var h;const n=u[o];if(0!==d)for(let t=0;t<d;t++){const o=l[t],r=await e.index.search(f,i,n,o);R(f.indexMap[n][o],r)}else{f.indexMap[n][""]=[];const t=await e.index.search(f,i,n,"");R(f.indexMap[n][""],t)}const r=f.indexMap[n],s=Object.values(r);f.docsIntersection[n]=rt(s,(null==t||null===(h=t.boost)||void 0===h?void 0:h[n])??1,a,d);const c=f.docsIntersection[n],p=c.length;for(let e=0;e<p;e++){const[t,n]=c[e],o=f.uniqueDocsIDs[t];f.uniqueDocsIDs[t]=o?o+n+.5:n}}}else 0===l.length&&r?f.uniqueDocsIDs={}:f.uniqueDocsIDs=Object.fromEntries(Object.keys(await e.documentsStore.getAll(e.data.docs)).map((e=>[e,0])));return jn(Object.entries(f.uniqueDocsIDs).map((([e,t])=>[+e,t])).sort(((e,t)=>t[1]-e[1])))}async function Ln(e,t){const n=t.vector,o=e.data.index.vectorIndexes[null==n?void 0:n.property],r=o.size,s=o.vectors;if(n&&(!n.value||!n.property))throw H("INVALID_VECTOR_INPUT",Object.keys(n).join(", "));if(n.value.length!==r)throw H("INVALID_INPUT_VECTOR",n.property,r,n.value.length);n instanceof Float32Array||(n.value=new Float32Array(n.value));return jn(it(n.value,s,r,t.similarity).map((([t,n])=>[ce(e.internalDocumentIDStore,t),n])))}function jn(e){const t=Math.max(...e.map((([,e])=>e)));return e.map((([e,n])=>[e,n/t]))}function Bn(e,t){return e/t}function Wn(e,t,n,o){return e*n+t*o}const Vn={k:1.2,b:.75,d:.5};async function Fn(e,t,n,o,r,s,a,i,c){const l={},u={};for(const e of s){const t={};for(const e of a)t[e]=[];l[e]=t,u[e]=[]}return{timeStart:c,tokenizer:e,index:t,documentsStore:n,language:o,params:r,docsCount:i,uniqueDocsIDs:{},indexMap:l,docsIntersection:u}}async function $n(e,t,n){const o=t.mode??Dn;if(o===Dn)return Rn(e,t,n);if("vector"===o)return zn(e,t);if("hybrid"===o)return Un(e,t);throw H("INVALID_SEARCH_MODE",o)}async function Gn(e,t,n,o){const r=e.data.docs,s=Array.from({length:o}),a=new Set;for(let i=n;i<o+n;i++){const n=t[i];if(void 0===n)break;const[o,c]=n;if(!a.has(o)){const t=await e.documentsStore.get(r,o);s[i]={id:le(e.internalDocumentIDStore,o),score:c,document:t},a.add(o)}}return s}async function Yn(e,t){e.internalDocumentIDStore.load(e,t.internalDocumentIDStore),e.data.index=await e.index.load(e.internalDocumentIDStore,t.index),e.data.docs=await e.documentsStore.load(e.internalDocumentIDStore,t.docs),e.data.sorting=await e.sorter.load(e.internalDocumentIDStore,t.sorting),e.tokenizer.language=t.language}async function qn(e){return{internalDocumentIDStore:e.internalDocumentIDStore.save(e.internalDocumentIDStore),index:await e.index.save(e.data.index),docs:await e.documentsStore.save(e.data.docs),sorting:await e.sorter.save(e.data.sorting),language:e.tokenizer.language}}async function Hn(e,t,n,o,r){!r&&e.beforeUpdate&&await Oe(e.beforeUpdate,e,t),await Sn(e,t,o,r);const s=await yn(e,n,o,r);return!r&&e.afterUpdate&&await Oe(e.afterUpdate,e,s),s}async function Kn(e,t,n,o,r,s){s||await Ae(e.beforeUpdateMultiple,e,t);const a=n.length;for(let t=0;t<a;t++){const o=await e.validateSchema(n[t],e.schema);if(o)throw H("SCHEMA_VALIDATION_FAILURE",o)}await Tn(e,t,o,r,s);const i=await In(e,n,o,r,s);return s||await Ae(e.afterUpdateMultiple,e,i),i}var Xn=Object.freeze({__proto__:null,boundedLevenshtein:async function(e,t,n){const o=Be(e,t,n);return{distance:o,isBounded:o>=0}},formatBytes:async function(e,t=2){if(0===e)return"0 Bytes";const n=t<0?0:t,o=Math.floor(Math.log(e)/Math.log(1024));return`${parseFloat((e/Math.pow(1024,o)).toFixed(n))} ${["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][o]}`},formatNanoseconds:U,getNanosecondsTime:C,uniqueId:L,convertDistanceToMeters:G,safeArrayPush:R,BM25:st,normalizeToken:on});export{dn as components,fn as count,ln as create,un as getByID,yn as insert,vn as insertMultiple,Xn as internals,hn as kInsertions,pn as kRemovals,Yn as load,Sn as remove,Tn as removeMultiple,qn as save,$n as search,zn as searchVector,Hn as update,Kn as updateMultiple};export default null;
//# sourceMappingURL=/sm/f1208b8da39e88ffb9187e916ad668a1b3429be5c97f19f4357d057615c48b93.map